var requestAtivo;
function atualizaTotal(){valor_frete=parseFloat($("input[name=formaEnvio]:checked").attr("data-valor")||0);cupom=$("#cupom_desconto").attr("data-cupom-desconto-codigo");aplicar_no_total=$("[data-desconto-valor]").attr("data-desconto-aplicar-no-total")||"n\u00e3o";var f=parseFloat($("[data-subtotal-valor]").attr("data-subtotal-valor")||0);envio_id=$("input[name=formaEnvio]:checked").val()||null;envio_code=$("input[name=formaEnvio]:checked").data("code");cart_items=[];$(".tabela-carrinho tr[data-produto-id]").each(function(){cart_items.push($(this).attr("data-produto-id"))});requestAtivo&&
(requestAtivo.abort(),requestAtivo=null);$(".valor-total").addClass("valor-loading");requestAtivo=$.getJSON("/carrinho/valor/",{envio_id,envio_code,valor_frete,valor_subtotal:f,cupom},function(a){$(".valor-total").html("R$ "+formatar_decimal_br(a.total));$(".valor-total").attr("data-total-valor",a.total);$("#cupom_valor_real").attr("data-desconto-valor-real",a.desconto_cupom);$("#cupom_valor_real").html(formatar_decimal_br(a.desconto_cupom));if(LOJA_MODO_MOSTRAR_PRECO){var d=!1;f!=a.valor_items&&
($(".valor-subtotal[data-subtotal-valor]").html("R$ "+formatar_decimal_br(a.valor_items)),$(".valor-subtotal[data-subtotal-valor]").attr("data-subtotal-valor",a.valor_items),d=!0);var g=a.valor_items_detalhe||[];if(g.length&&cart_items.length){g.length!==cart_items.length&&$.fancybox({type:"inline",content:'<h5 style="line-height: 25px; white-space: nowrap; text-align: center; margin: 20px 0;">Os itens no carrinho foram alterados.<br />Atualize a p\u00e1gina para continuar.</h5>'});for(var h=0;h<
g.length;h++){var e=g[h];if(0>cart_items.indexOf(String(e.id)))$.fancybox({type:"inline",content:'<h5 style="line-height: 25px; white-space: nowrap; text-align: center; margin: 20px 0;">Itens no carrinho alterados.<br />Atualize a p\u00e1gina para continuar.</h5>'});else{var c=$(".tabela-carrinho tr[data-produto-id="+e.id+"]");if(c.length){var b=!!window.CARRINHO_ANTIGO;c.attr("data-produto-quantidade")!=String(e.quantity)&&(c.attr("data-produto-quantidade",e.quantity),c.find('.quantidade input[type="text"]').val(e.quantity));
if(c.find(".col-item-unit-price[data-item-unit-valor]").length&&b){b=e.price.sellingPrice;var k=parseFloat(c.find(".col-item-unit-price[data-item-unit-valor]").attr("data-item-unit-valor")||0)}else b=e.price.sellingPrice*e.quantity,k=parseFloat(c.find(".col-item-unit-price[data-item-unit-valor]").attr("data-item-unit-valor")||0)*e.quantity;k!=b&&(c.find(".col-item-unit-price[data-item-unit-valor]").attr("data-item-unit-valor",b),c.find(".col-item-unit-price .preco-produto .preco-promocional").html("R$ "+
formatar_decimal_br(b)),c.find(".col-item-subtotal-price .preco-produto .preco-promocional").html("R$ "+formatar_decimal_br(b*e.quantity)),d=!0)}}}}d&&$.fancybox({type:"inline",content:'<h5 style="line-height: 25px; white-space: nowrap; text-align: center; margin: 20px 0;">Um ou mais itens tiveram altera\u00e7\u00e3o de pre\u00e7o.<br />Verifique o novo valor antes de continuar.</h5>'})}0<$("#li-box-payment-minimum-value").length&&(a.pci_total>=a.minimum_value.value||0==a.pci_total?$("#li-box-payment-minimum-value").slideUp():
0<a.minimum_value.value&&($(".li-box-payment-minimum-value-left").text("R$"+formatar_decimal_br(a.minimum_value.value-a.pci_total)),$("#li-box-payment-minimum-value").slideDown()));$(".valores-descontos").length?$(".valores-descontos").load("/carrinho/valor-descontos",function(){$(".valor-total").removeClass("valor-loading")}):$(".valor-total").removeClass("valor-loading");$(".valor-total").trigger("valor_total_alterado",a)}).fail(function(){$(".valor-total").removeClass("valor-loading")})}
var frete_gratis=!1;
function carregarFormasEnvio(f,a){var d=URL_CALCULO_FRETE;$(".formas-envio").addClass("valor-loading");$.getJSON(d,f,function(g){if(g.deliveries&&0<g.deliveries.length){$(".formas-envio ul").html("");var h="";h='<li><label class="radio"><input type="radio" name="formaEnvio" value=":id:" data-valor=":valor_float:" data-code=":code:"><b class="prazo">:prazo: :prazo_dia:</b> <span class="cor-principal valor">R$ :valor:</span> <span class="nome">:nome:</span>';for(var e in g.deliveries){var c=g.deliveries[e],
b=h;c.name&&("mercadoenvios_api"==c.type&&(c.name=c.name.replace("MercadoEnvios ","")),b=b.replace(":id:",c.id),b=b.replace(":nome:",c.name),frete_gratis&&"frete_gratis"==c.service_name?(b=b.replace(":valor:","0,00"),b=b.replace(":valor_float:","0")):(b=b.replace(":valor:",formatar_decimal_br(c.price)),b=b.replace(":valor_float:",c.price)),b=b.replace(":code:",c.code),b=b.replace(":prazo:",c.deliveryTime),b=b.replace(":prazo_dia:",1==c.deliveryTime?"dia \u00fatil":"dias \u00fateis"),c.msgErro&&(b+=
'<span class="aviso" style="display: none;">'+c.msgErro+"</span>"),b+="</li>",$(".formas-envio ul").append(b))}$.cookie("forma_envio")&&($(".formas-envio input[value="+$.cookie("forma_envio")+"]").prop("checked",!0),$.cookie("forma_envio_code")&&$(".formas-envio input[value="+$.cookie("forma_envio")+"][data-code="+$.cookie("forma_envio_code")+"]").prop("checked",!0));atualizaTotal()}else $(".formas-envio ul").html(""),a?$(".formas-envio ul").append("<li>Nenhuma forma de envio encontrada.</li>"):setTimeout(function(){carregarFormasEnvio(f,
!0)},500);setTimeout(function(){$(".formas-envio").trigger("formas_envio_alterado",g)},1)}).fail(function(){$(".formas-envio ul").html("");a?$(".formas-envio ul").append("<li>N\u00e3o foi poss\u00edvel carregar as formas de envio. Tente novamente.</li>"):setTimeout(function(){carregarFormasEnvio(f,!0)},500)}).always(function(){$(".formas-envio").removeClass("valor-loading")})}
$(function(){$("[rel=tooltip]").tooltip();"frete-gratis"==$("[data-desconto-tipo]").attr("data-desconto-tipo")&&(frete_gratis=!0);var f=$.cookie("cep");f&&0>f.indexOf("*")&&f!==$("#formCalcularFrete .input-cep").val()&&$("#formCalcularFrete .input-cep").val(f);$("#formCalcularFrete").submit(function(){var a=$(this).find(".input-cep"),d=a.val();if(!d)return!1;d=d.replace("-","");a=a.data("cep-usuario")?String(a.data("cep-usuario")).replace("-",""):"";d!=a&&$.cookie("cep",d,{expires:7,path:"/"});carregarFormasEnvio({cep:d},
!1);return!1}).submit();$("#formCalcularFrete .input-cep").bind("change keyup input",function(){var a=$(this).data("cep_old"),d=$(this).val();a!=d&&9==$(this).val().length&&0>$(this).val().indexOf("_")&&($(this).data("cep_old",d),$("#formCalcularFrete").submit())});$(".formas-envio ul").click(function(){var a=$('input[name="formaEnvio"]:checked').val();$.cookie("forma_envio",a,{expires:7,path:"/"});a=$('input[name="formaEnvio"]:checked').attr("data-code");$.cookie("forma_envio_code",a,{expires:7,
path:"/"});atualizaTotal()});$(".formas-envio").on("change",'input[name="formaEnvio"]',function(){$("#formCalcularFrete .controls .envio-aviso").length&&$("#formCalcularFrete .controls .envio-aviso").remove();$(this).parent().find(".aviso").length&&$("#formCalcularFrete .controls").append('<p class="envio-aviso">'+$(this).parent().find(".aviso").text()+"</p>")});$(".tabela-carrinho").length&&atualizaTotal();$("#modalSolicitarOrcamento").on("hidden",function(a){$(this).removeData()});$("[name=quantidade]").keyup(function(a){$(this).parent().find(".atualizar-quantidade").fadeIn()});
$("[name=quantidade]").focusout(function(a){$(this).parent().find(".atualizar-quantidade").fadeOut()})});
